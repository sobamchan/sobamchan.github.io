---
title: "PostgreSQL: Rank関数を使ってユーザーの最初の投稿を抽出する"
date: 2020-05-25T10:53:41+09:00
draft: false
toc: false
images:
  - /imgs/postgres-rank-function.jpg
tags:
  - sql
  - postgresql
---

{{< figure src="/imgs/postgres-rank-function.jpg" alt="image" >}}


## tl;dr

- 各ユーザー最初の投稿を PostgreSQL の RANK function を使って抽出する


## 背景

アプリケーションのデータとして，このような構造を持つものは多いと思います．

| id | user_id | content    | created_at |
|----|---------|------------|------------|
| 1  | 1       | hello      | 2020-01-01 |
| 2  | 1       | world      | 2020-01-02 |
| 3  | 2       | hola       | 2020-01-02 |
| 4  | 2       | mundo      | 2020-01-02 |
| 5  | 3       | こんにちは | 2020-01-03 |

ユーザーが投稿する系のサービスでは基本，こんな構造を持っているはずです．


## 問題設定

このようなサービスの分析としてよくやりたい基本操作が，「各ユーザーの初回投稿がいつだったか調べる．」です．
つまり，先ほどのテーブルから以下の情報を抽出する操作です．

| id | user_id | content    | created_at |
|----|---------|------------|------------|
| 1  | 1       | hello      | 2020-01-01 |
| 3  | 2       | hola       | 2020-01-02 |
| 5  | 3       | こんにちは | 2020-01-03 |

各ユーザーの初回投稿のみが得られています．

このような情報抽出を行うと，以下のような分析を行うのに役立ちそうです．

- ユーザーが登録してから，初回投稿までの経過時間の調査．
- 初回投稿に利用される単語の出現頻度．

ユーザーに第一回目の行動を起こさせるか，というのはサービスの活性化に大きく貢献することが多いので，
有用な情報になりそうですね．


## 実装

これを実現するために必要な操作を簡単にまとめると，以下のようになります．

1. 各データを作成順にソートする (今回のデータの場合は，`id` を降順にソートすれば良い．)．
2. `user_id` ごとにグルーピングする．
3. 各グループから `id` が一番小さいものを抽出する．


これを SQL で行うには，いくつか方法がありますが， PostgreSQL には [RANK function](https://www.postgresqltutorial.com/postgresql-rank-function/) なる
便利関数が実装してあり，これを利用すると簡単にできます．

この関数は，テーブルに対して，グルーピングを行うカラムの指定と，並び替えの方法を指定すると，
それに従って，グループ内の各データにランキングを数値で (1, 2, 3, ...) 付与してくれます．

RANK function は以下のようなシンタックスで利用できます．

```
RANK() OVER (
    [PARTITION BY partition_expression, ... ]
    ORDER BY sort_expression [ASC | DESC], ...
)
```

これをみて分かるように，`partition by` にグルーピングの単位， `order by` に並び替えの方法の指定を行います．

今回の問題にこれを当てはめて使ってみると，

```sql
select
  *,
  rank() over (partition by user_id order by id)
from
  posts
```

以下のように書けます．これを実行すると．


| id | user_id | content    | created_at | rank |
|----|---------|------------|------------| ---- |
| 1  | 1       | hello      | 2020-01-01 | 1    |
| 2  | 1       | world      | 2020-01-02 | 2    |
| 3  | 2       | hola       | 2020-01-02 | 1    |
| 4  | 2       | mundo      | 2020-01-02 | 2    |
| 5  | 3       | こんにちは | 2020-01-03 | 1    |

このように，`rank` というカラムが作成され，その中に数字が入っているのがわかります．
ここには，要件を満たすように，各ユーザーごとにそのカウントがリセットされており，
`id` カラムに応じてランキングがされています．

ここから先は単純です．

先ほどの処理をネストさせて，`where`句で `rank = 1` だけを表示するようにすれば，
最初に欲しかったデータのみを得ることができます．
```sql
select
  *
from
(
  select
    *,
    rank() over (partition by user_id order by id)
  from
    posts
 ) as tmp
 where
   rank = 1
```

| id | user_id | content    | created_at | rank |
|----|---------|------------|------------| ---- |
| 1  | 1       | hello      | 2020-01-01 | 1    |
| 3  | 2       | hola       | 2020-01-02 | 1    |
| 5  | 3       | こんにちは | 2020-01-03 | 1    |


## まとめ

RANK function を使うと，「最初の ** 」のような情報を簡単に抽出することができ，
これを基本にして他の実際に有用な分析の起点とし，サービスに関しての多くの知見を引き出すことができます．
